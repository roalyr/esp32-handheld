--- Start of ./src/app_interface.h ---

// [Revision: v1.0] [Path: src/app_interface.h] [Date: 2025-12-10]
// Description: Abstract base class defining the standard interface for all applications.

#ifndef APP_INTERFACE_H
#define APP_INTERFACE_H

#include "hal.h"

class App {
  public:
    virtual ~App() {}

    // Called when the app becomes active
    virtual void start() = 0;

    // Called when the app is being switched away from
    virtual void stop() = 0;

    // Main logic loop (physics, timers, etc.)
    virtual void update() = 0;

    // Drawing logic
    virtual void render() = 0;

    // Input handling (only called on just-pressed events)
    virtual void handleInput(char key) = 0;
};

#endif

--- Start of ./src/apps/asteroids.h ---

// [Revision: v1.0] [Path: src/apps/asteroids.h] [Date: 2025-12-10]
// Description: Asteroids Arcade Game.
// features: Vector physics, screen wrapping, collision detection, particle system.

#ifndef APP_ASTEROIDS_H
#define APP_ASTEROIDS_H

#include "../app_interface.h"
#include <vector>

struct Vec2 {
    float x, y;
};

struct Bullet {
    Vec2 pos;
    Vec2 vel;
    int life;     // Frames remaining
    bool active;
};

struct Asteroid {
    Vec2 pos;
    Vec2 vel;
    int size;     // 3=Large, 2=Medium, 1=Small
    int radius;
    float seed;   // Random seed for jagged shape generation
    bool active;
};

struct Particle {
    Vec2 pos;
    Vec2 vel;
    int life;
    bool active;
};

class AsteroidsApp : public App {
  private:
    // Game Objects
    Vec2 shipPos;
    Vec2 shipVel;
    float shipAngle; // Radians
    bool isThrusting;
    
    // Object Pools
    std::vector<Bullet> bullets;
    std::vector<Asteroid> asteroids;
    std::vector<Particle> particles;

    // Game State
    int score;
    bool gameOver;
    int level;
    unsigned long lastShotTime;

    // Helpers
    void spawnAsteroid(float x, float y, int size);
    void spawnBullet();
    void createExplosion(float x, float y, int count);
    void resetGame();
    void nextLevel();
    bool checkCollision(float x1, float y1, float r1, float x2, float y2, float r2);
    void drawWireframeModel(const float* coords, int numPoints, float x, float y, float angle, float scale);

  public:
    AsteroidsApp();
    void start() override;
    void stop() override;
    void update() override;
    void render() override;
    void handleInput(char key) override;
};

#endif

--- Start of ./src/apps/gfx_test.h ---

// [Revision: v2.1] [Path: src/apps/gfx_test.h] [Date: 2025-12-10]
// Description: Header for GFX Test. Added timing variables for contrast control.

#ifndef APP_GFX_TEST_H
#define APP_GFX_TEST_H

#include "../app_interface.h"

class GfxTestApp : public App {
  private:
    int currentContrast;
    int contrastDir;
    
    // Timing Control
    unsigned long lastStepTime;
    int stepInterval; // ms per contrast step

  public:
    GfxTestApp();
    void start() override;
    void stop() override;
    void update() override;
    void render() override;
    void handleInput(char key) override;
};

#endif

--- Start of ./src/apps.h ---

#ifndef APPS_H
#define APPS_H

#include "hal.h"
#include "t9_engine.h"

// --- EXISTING APPS ---
void renderT9Editor();
void renderKeyTester(char lastKey, char* heldKeys, int count);
void setupTester();
void addToTesterHistory(char c);

// --- SNAKE GAME ---
void setupSnake();
void handleSnakeInput(char key);
void updateSnake();
void renderSnake();

// --- GFX TESTER ---
void renderGfxTest();

#endif

--- Start of ./src/apps/key_tester.h ---

// [Revision: v2.0] [Path: src/apps/key_tester.h] [Date: 2025-12-10]
// Description: Key Tester Application class definition.

#ifndef APP_KEY_TESTER_H
#define APP_KEY_TESTER_H

#include "../app_interface.h"

class KeyTesterApp : public App {
  private:
    char lastPressedKey;
    static const int HISTORY_SIZE = 14;
    char keyHistory[HISTORY_SIZE + 1];

    void addToHistory(char c);

  public:
    KeyTesterApp(); // Constructor to init buffers
    void start() override;
    void stop() override;
    void update() override;
    void render() override;
    void handleInput(char key) override;
};

#endif

--- Start of ./src/apps/menu.h ---

// [Revision: v2.2] [Path: src/apps/menu.h] [Date: 2025-12-10]
// Description: Menu Header. Added scroll tracking.

#ifndef APP_MENU_H
#define APP_MENU_H

#include "../app_interface.h"

class MenuApp : public App {
  private:
    static const int ITEM_COUNT = 6;
    const char* menuItems[ITEM_COUNT] = {
      "1. T9 Editor",
      "2. Key Tester",
      "3. Snake Game",
      "4. GFX Test",
      "5. Asteroids",
      "6. Stopwatch"
    };

    int selectedIndex;
    int scrollOffset; // Index of the first visible item
    int pendingSwitchIndex; 

  public:
    MenuApp();
    void start() override;
    void stop() override;
    void update() override;
    void render() override;
    void handleInput(char key) override;
    int getPendingSwitch(); 
};

#endif

--- Start of ./src/apps/snake.h ---

// [Revision: v2.1] [Path: src/apps/snake.h] [Date: 2025-12-10]
// Description: Updated for frame-counter timing.

#ifndef APP_SNAKE_H
#define APP_SNAKE_H

#include "../app_interface.h"

struct Point { 
    int x, y;
};

class SnakeApp : public App {
  private:
    static const int MAX_SNAKE_LEN = 100;
    static const int SNAKE_BLOCK_SIZE = 4;
    static const int BOARD_W = 128 / SNAKE_BLOCK_SIZE;
    static const int BOARD_H = 64 / SNAKE_BLOCK_SIZE;

    Point snake[MAX_SNAKE_LEN];
    int snakeLen;
    int dirX, dirY;
    Point food;
    bool gameOver;
    
    // New Timing Logic
    int moveInterval;    // Frames between moves
    int framesSinceMove; // Counter

    void spawnFood();
    void resetGame();

  public:
    SnakeApp();
    void start() override;
    void stop() override;
    void update() override;
    void render() override;
    void handleInput(char key) override;
};

#endif

--- Start of ./src/apps/stopwatch.h ---

// [Revision: v1.0] [Path: src/apps/stopwatch.h] [Date: 2025-12-10]
// Description: Stopwatch Application. 
// Features: Independent timekeeping (millis-based), Pause/Resume, Reset.

#ifndef APP_STOPWATCH_H
#define APP_STOPWATCH_H

#include "../app_interface.h"

class StopwatchApp : public App {
  private:
    bool isRunning;
    unsigned long startTime;       // Time stamp when "Start" was pressed
    unsigned long accumulatedTime; // Time stored from previous sessions (before pause)
    
    // Helper to calculate time to display
    unsigned long getTotalTime();

  public:
    StopwatchApp();
    void start() override;
    void stop() override;
    void update() override;
    void render() override;
    void handleInput(char key) override;
};

#endif

--- Start of ./src/apps/t9_editor.h ---

// [Revision: v4.1] [Path: src/apps/t9_editor.h] [Date: 2025-12-10]
// Description: Added exitRequested flag and refined cursor logic.

#ifndef APP_T9_EDITOR_H
#define APP_T9_EDITOR_H

#include "../app_interface.h"
#include "../t9_engine.h"
#include <vector>

struct VisualLine {
    String content;     
    int logicalLineNum; 
    bool hasCursor;     
    int byteStartIndex; // Index in textBuffer where this line starts
    int byteLength;     // Length of this line in bytes
};

enum EditorState {
    STATE_EDITING,
    STATE_HELP,
    STATE_EXIT_CONFIRM
};

class T9EditorApp : public App {
  private:
    // Layout State
    std::vector<VisualLine> visualLines;
    int scrollOffset;   
    
    // Caching
    String lastProcessedText;
    bool lastPendingState;
    String lastCandidate;
    int lastCursorPos;

    // Config
    const int LINE_HEIGHT = 13; 
    const int HEADER_HEIGHT = 12;
    const int GUTTER_WIDTH = 18;
    const int TEXT_AREA_WIDTH = 128 - GUTTER_WIDTH - 2; 
    const int VISIBLE_LINES = (64 - HEADER_HEIGHT) / LINE_HEIGHT;

    // New UI State
    EditorState currentState;
    String fileName;
    int helpScrollY;
    bool exitSelection; // true=YES, false=NO

    // Internal Helpers
    void recalculateLayout();
    void moveCursorVertically(int dir); // -1 Up, +1 Down
    void renderHeader();
    void renderHelpPopup();
    void renderExitPopup();

  public:
    T9EditorApp();
    
    // Communication flag for Main loop
    bool exitRequested; 

    void start() override;
    void stop() override;
    void update() override;
    void render() override;
    void handleInput(char key) override;
};

#endif

--- Start of ./src/config.h ---

// [Revision: v2.2] [Path: src/config.h] [Date: 2025-12-10]
// Description: Global hardware definitions and timing constants.

#ifndef CONFIG_H
#define CONFIG_H

#include <Arduino.h>

// --------------------------------------------------------------------------
// HARDWARE PINS (ESP32-S3)
// --------------------------------------------------------------------------

#define PIN_CS  10
#define PIN_DC  5
#define PIN_RST 4

// Key Matrix Dimensions
const byte ROWS = 4;
const byte COLS = 5;

// Global hardware pin arrays (Defined in hal.cpp)
extern byte rowPins[ROWS];
extern byte colPins[COLS];
extern char keyMap[ROWS][COLS];

// --------------------------------------------------------------------------
// TIMING & CONFIG CONSTANTS
// --------------------------------------------------------------------------

#define PHYSICAL_FPS 10
#define FRAME_DELAY_MS (1000 / PHYSICAL_FPS)

#define MULTITAP_TIMEOUT 800   
#define CURSOR_BLINK_RATE 500
#define DEFAULT_CONTRAST 0     // Global default contrast (0-255)

#endif

--- Start of ./src/hal.h ---

// [Revision: v2.0] [Path: src/hal.h] [Date: 2025-12-10]
// Description: Added systemContrast external declaration.

#ifndef HAL_H
#define HAL_H

#include <Arduino.h>
#include <U8g2lib.h>
#include "config.h"

// --------------------------------------------------------------------------
// DISPLAY EXPORTS
// --------------------------------------------------------------------------

extern U8G2_ST7565_ERC12864_F_4W_HW_SPI u8g2;
extern const uint8_t* FONT_SMALL; 
extern int systemContrast; // Global system contrast variable

// --------------------------------------------------------------------------
// INPUT EXPORTS
// --------------------------------------------------------------------------

#define MAX_PRESSED_KEYS 6

extern char activeKeys[MAX_PRESSED_KEYS];
extern int activeKeyCount;

// --------------------------------------------------------------------------
// CORE FUNCTIONS
// --------------------------------------------------------------------------

void setupHardware();           
void scanMatrix();              
bool isJustPressed(char key);   

#endif

--- Start of ./src/t9_engine.h ---

// [Revision: v2.1] [Path: src/t9_engine.h] [Date: 2025-12-10]
// Description: Added Cursor Position support for navigation and insertion.

#ifndef T9_ENGINE_H
#define T9_ENGINE_H

#include <Arduino.h>
#include "config.h"

class T9Engine {
  private:
    // Input State
    char pendingKey = '\0';          
    int cycleIndex = 0;              
    unsigned long lastPressTime = 0; 
    bool isShifted = false;          

    // UTF-8 Helper Methods
    int getUtf8Length(const char* str);
    String getUtf8CharAtIndex(const char* str, int index);

  public:
    // Editor State
    String textBuffer = "";
    int cursorPos = 0; // Current insertion point (byte index)
    bool pendingCommit = false; 

    // Getters
    unsigned long getLastPressTime();
    String getCurrentChar(); 

    // Core Logic
    void handleInput(char key); 
    void update();              
    void commit();              
    void reset();               
    
    // Navigation Helpers
    void moveCursor(int delta); // Move by UTF-8 characters
    void setCursor(int pos);    // Set raw byte index
};

extern T9Engine engine;

#endif
