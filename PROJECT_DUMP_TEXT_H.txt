--- Start of ./src/apps/gfx_test.h ---

// [Revision: v1.0] [Path: src/apps/gfx_test.h] [Date: 2025-12-09]
// Description: Header for the Graphics & Hardware Test application.

#ifndef APP_GFX_TEST_H
#define APP_GFX_TEST_H

#include "../hal.h"

// Renders the graphics test pattern and cycles hardware contrast automatically.
void renderGfxTest();

#endif

--- Start of ./src/apps.h ---

#ifndef APPS_H
#define APPS_H

#include "hal.h"
#include "t9_engine.h"

// --- EXISTING APPS ---
void renderT9Editor();
void renderKeyTester(char lastKey, char* heldKeys, int count);
void setupTester();
void addToTesterHistory(char c);

// --- SNAKE GAME ---
void setupSnake();
void handleSnakeInput(char key);
void updateSnake();
void renderSnake();

// --- GFX TESTER ---
void renderGfxTest();

#endif

--- Start of ./src/apps/key_tester.h ---

// [Revision: v1.0] [Path: src/apps/key_tester.h] [Date: 2025-12-09]
// Description: Header for the Key Matrix Tester application.

#ifndef APP_KEY_TESTER_H
#define APP_KEY_TESTER_H

#include "../hal.h"

// Initialize tester state (clear history)
void setupTester();

// Add a key to the scrolling history buffer
void addToTesterHistory(char c);

// Render the debug interface showing history, last pressed key, and currently held keys
void renderKeyTester(char lastKey, char* heldKeys, int count);

#endif

--- Start of ./src/apps/snake.h ---

// [Revision: v1.0] [Path: src/apps/snake.h] [Date: 2025-12-09]
// Description: Header for the Snake Game application.

#ifndef APP_SNAKE_H
#define APP_SNAKE_H

#include "../hal.h"

// Initialize game state, reset score, spawn first food
void setupSnake();

// Handle directional input (2/4/6/8) and restart (5)
void handleSnakeInput(char key);

// Main game loop logic (movement, collision, eating)
void updateSnake();

// Render game board and game over screen
void renderSnake();

#endif

--- Start of ./src/apps/t9_editor.h ---

// [Revision: v1.0] [Path: src/apps/t9_editor.h] [Date: 2025-12-09]
// Description: Header for the T9 Editor Application.

#ifndef APP_T9_EDITOR_H
#define APP_T9_EDITOR_H

#include "../hal.h"
#include "../t9_engine.h"

// Renders the T9 text editor interface, including the text buffer,
// pending character candidate, timeout bar, and cursor.
void renderT9Editor();

#endif

--- Start of ./src/config.h ---

// [Revision: v1.0] [Path: src/config.h] [Date: 2025-12-09]
// Description: Global hardware definitions, timing constants, and system mode enums.

#ifndef CONFIG_H
#define CONFIG_H

#include <Arduino.h>

// --------------------------------------------------------------------------
// HARDWARE PINS (ESP32-S3)
// --------------------------------------------------------------------------

// Display (ST7565 / ERC12864-4)
#define PIN_CS  10
#define PIN_DC  5
#define PIN_RST 4

// Key Matrix Dimensions
const byte ROWS = 4;
const byte COLS = 5;

// Global hardware pin arrays (Defined in hal.cpp)
extern byte rowPins[ROWS];
extern byte colPins[COLS];
extern char keyMap[ROWS][COLS];

// --------------------------------------------------------------------------
// TIMING CONSTANTS
// --------------------------------------------------------------------------

#define MULTITAP_TIMEOUT 800   // Max time (ms) between presses for T9 cycling
#define CURSOR_BLINK_RATE 500  // Blinking cursor interval (ms)

// --------------------------------------------------------------------------
// SYSTEM STATES
// --------------------------------------------------------------------------

enum SystemMode {
  MODE_T9_EDITOR,
  MODE_KEY_TESTER,
  MODE_SNAKE,
  MODE_GFX_TEST
};

#endif

--- Start of ./src/hal.h ---

// [Revision: v1.0] [Path: src/hal.h] [Date: 2025-12-09]
// Description: Hardware Abstraction Layer declarations for Display and Input Matrix.

#ifndef HAL_H
#define HAL_H

#include <Arduino.h>
#include <U8g2lib.h>
#include "config.h"

// --------------------------------------------------------------------------
// DISPLAY EXPORTS
// --------------------------------------------------------------------------

// Main display object (ST7565 via SPI)
extern U8G2_ST7565_ERC12864_F_4W_HW_SPI u8g2;

// Shared font resource to reduce memory duplication
extern const uint8_t* FONT_SMALL; 

// --------------------------------------------------------------------------
// INPUT EXPORTS
// --------------------------------------------------------------------------

#define MAX_PRESSED_KEYS 6

// Array holding keys currently pressed in this frame
extern char activeKeys[MAX_PRESSED_KEYS];
extern int activeKeyCount;

// --------------------------------------------------------------------------
// CORE FUNCTIONS
// --------------------------------------------------------------------------

void setupHardware();           // Initialize pins and display
void scanMatrix();              // Poll the keypad matrix (call every loop)
bool isJustPressed(char key);   // True if key was not pressed in previous frame

#endif

--- Start of ./src/t9_engine.h ---

// [Revision: v1.0] [Path: src/t9_engine.h] [Date: 2025-12-09]
// Description: T9 Predictive Text / Multi-tap Engine class declaration.

#ifndef T9_ENGINE_H
#define T9_ENGINE_H

#include <Arduino.h>
#include "config.h"

class T9Engine {
  private:
    // Input State
    char pendingKey = '\0';          // The number key currently being cycled
    int cycleIndex = 0;              // Current index in the character map for the key
    unsigned long lastPressTime = 0; // Timestamp of last press for timeout logic
    bool isShifted = false;          // Shift/Caps Lock state

    // UTF-8 Helper Methods
    int getUtf8Length(const char* str);
    String getUtf8CharAtIndex(const char* str, int index);

  public:
    // Editor State (Public for Renderer access)
    String textBuffer = "";
    bool pendingCommit = false; // True if user is currently cycling a character

    // Getters
    unsigned long getLastPressTime();
    String getCurrentChar(); // Returns the character currently being cycled

    // Core Logic
    void handleInput(char key); // Process raw key input
    void update();              // Call in loop to handle timeout commits
    void commit();              // Force commit of pending character
    void reset();               // Clear buffer and state
};

extern T9Engine engine;

#endif
